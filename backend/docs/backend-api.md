# Backend API Documentation

Base URL (dev)

- http://localhost:8000

Auth and identity

- Logged-in: Django session cookie.
- Anonymous: anon_token cookie set by backend, or X-Anonymous-Token header for non-browser clients.
- All endpoints return JSON.

CORS/CSRF (dev)

- CORS allowed origin: http://localhost:3000
- Credentials allowed: true (cookies)
- CSRF trusted origin: http://localhost:3000

---

## Customers API

Base: /api/customer/

POST /api/customer/register/

- Body: username, password, email, first_name, last_name, phone
- Creates a user and logs in.

POST /api/customer/login/

- Body: username (or email), password

POST /api/customer/logout/

GET /api/customer/status/

- Returns loggedIn flag.

GET /api/customer/user/

- Returns current user profile if logged in.

PUT /api/customer/edit/

- Body: username, password, email, first_name, last_name, phone

GET|POST|PUT /api/customer/address/

- Anonymous requires anon_token cookie/header.
- Uses Address.session_key for anonymous.

---

## Products API

Base: /api/product/

Request body format notes

- Use JSON for non-file fields.
- Endpoints with image fields should be sent as multipart/form-data.
- UUID fields below mean UUID string values.
- Date/time fields use ISO-8601 datetime strings.
- Decimal fields should be sent as numeric strings (recommended) or numbers.
- Slugs are Unicode-aware (Georgian and other non-Latin characters are preserved).

Write-body conventions

- Client should send = fields frontend should normally provide.
- Accepted but backend-managed = fields the serializer may accept but are generated/managed by server in normal flow, so frontend should not send them.

Books

- GET /books/
- POST /books/
  - Client should send:
    - Required: title (string), art_style (string)
    - Optional: slug (string), style_version (string), print_size (string), paper_type (string), binding_type (string)
  - Accepted but backend-managed (avoid sending):
    - status (enum), total_pages (integer), last_generation_at (datetime), current_cover_version (UUID), is_print_ready (boolean), print_locked_at (datetime), is_consistency_verified (boolean), total_images_generated (integer), total_generation_cost_usd (decimal), is_archived (boolean), archived_at (datetime)
  - Auto-generated by server: id (UUID), created_at (datetime)
  - Auto-generated when omitted/blank: slug (derived from title, made unique per owner scope)
  - Ownership set by server: user (authenticated), session_key (anonymous)
  - Ownership fields are not returned in Book API responses: user, session_key
  - Anonymous: only 1 book allowed (per anon profile)
  - Sets Book.session_key to anon token
- GET|PUT|PATCH|DELETE /books/<uuid:item_id>/
  - PUT client should send required: title (string), art_style (string)
  - PUT optional: slug (string)
  - PATCH client should send: only changed editable fields
  - Backend-managed (avoid sending): id, user, session_key, created_at

Characters

- GET /characters/
- POST /characters/
  - Client should send:
    - Required: book (UUID), name (string), reference_photo (file/image)
  - Accepted but backend-managed (avoid sending):
    - current_version (UUID), total_generation_attempts (integer), free_retry_used (boolean)
  - Auto-generated by server: id (UUID), created_at (datetime), updated_at (datetime)
  - Ownership set by server: user (authenticated), created_by_anon_token (anonymous)
  - Anonymous: allowed once, must match Book.session_key
- GET|PUT|PATCH|DELETE /characters/<uuid:item_id>/
  - PUT client should send required: book (UUID), name (string), reference_photo (file/image)
  - PATCH client should send: only changed editable fields
  - Backend-managed (avoid sending): id, user, created_by_anon_token, created_at, updated_at

Character Versions

- GET /character-versions/
- POST /character-versions/
  - Client should send:
    - Required: character (UUID), generated_image (file/image), prompt_snapshot (JSON object), aspect_ratio (string), generation_job_id (UUID)
    - Optional: thumbnail (file/image), seed (integer)
  - Accepted but backend-managed (avoid sending):
    - version_number (integer), generation_cost_usd (decimal), ledger_entry (UUID), status (enum: PENDING | GENERATING | SUCCESS | FAILED), error_message (string), generation_time_ms (integer), nano_request_id (string)
  - Auto-generated by server: id (UUID), created_at (datetime), version_number (integer)
  - Logged-in: allowed, consumes retry allowance
  - Anonymous: allowed only for owned anonymous character
  - Server assigns version_number
- GET|PUT|PATCH|DELETE /character-versions/<uuid:item_id>/
  - PUT client should send required: character (UUID), generated_image (file/image), prompt_snapshot (JSON object), aspect_ratio (string), generation_job_id (UUID)
  - PATCH client should send: only changed editable fields
  - Backend-managed (avoid sending): id, created_at

Cover Versions

- GET /cover-versions/
- POST /cover-versions/
  - Client should send:
    - Required: book (UUID), title_text (string), generated_image (file/image), prompt_snapshot (JSON object), aspect_ratio (string), generation_job_id (UUID)
    - Optional: subtitle_text (string), author_name (string), title_position (JSON object), full_spread_image (file/image), thumbnail (file/image), seed (integer)
  - Accepted but backend-managed (avoid sending):
    - version_number (integer), generation_cost_usd (decimal), ledger_entry (UUID), status (enum: PENDING | GENERATING | SUCCESS | FAILED), nano_request_id (string), error_message (string), generation_time_ms (integer)
  - Auto-generated by server: id (UUID), created_at (datetime), updated_at (datetime), version_number (integer)
  - Ownership set by server: created_by_user, created_by_anon_token
  - Logged-in: allowed, consumes retry allowance
  - Anonymous: allowed only for owned anonymous book
  - Server assigns version_number
- GET|PUT|PATCH|DELETE /cover-versions/<uuid:item_id>/
  - PUT client should send required: book (UUID), title_text (string), generated_image (file/image), prompt_snapshot (JSON object), aspect_ratio (string), generation_job_id (UUID)
  - PATCH client should send: only changed editable fields
  - Backend-managed (avoid sending): id, created_by_user, created_by_anon_token, created_at, updated_at

Pages

- GET /pages/ (logged-in only)
- POST /pages/ (logged-in only)
  - Client should send:
    - Required: book (UUID), page_number (positive integer)
    - Optional: scene_description (string), text_content (string)
  - Accepted but backend-managed (avoid sending):
    - current_version (UUID), is_locked (boolean)
  - Auto-generated by server: id (UUID)
- GET|PUT|PATCH|DELETE /pages/<uuid:item_id>/ (logged-in only)
  - PUT client should send required: book (UUID), page_number (positive integer)
  - PATCH client should send: only changed editable fields
  - Backend-managed (avoid sending): id

Page Versions

- GET /page-versions/ (logged-in only)
- POST /page-versions/ (logged-in only)
  - Client should send:
    - Required: page (UUID of Page)
    - Optional: prompt (JSON object preferred; string also accepted)
  - Accepted but backend-managed (avoid sending):
    - version_number (integer), nano_request_id (string), ledger_entry (UUID), generation_cost_usd (decimal), image (file/image), status (enum: PENDING | GENERATING | COMPLETED | FAILED)
  - Auto-generated by server: id (UUID), created_at (datetime), version_number (integer)
  - Generated by server workflow: prompt (normalized snapshot), status transitions, nano_request_id, image, generation_cost_usd, ledger_entry
  - Consumes retry allowance
  - Server creates generated version payload
- GET|PUT|PATCH|DELETE /page-versions/<uuid:item_id>/ (logged-in only)
  - PUT client should send required: page (UUID)
  - PATCH client should send: only changed editable fields
  - Backend-managed (avoid sending): id, created_at

Retry Pack Apply

- POST /retries/add/
- Required body fields:
  - content_type (string enum: CHARACTER | COVER | PAGE)
  - content_id (UUID)
  - retry_pack_order_id (UUID)
- Server-managed fields: consumed_at and allowance updates are handled by backend
- Requires: paid RetryPackOrder, must match item and user

---

## Orders API

Base: /api/orders/

POST /create/

- Body:
  - tier_name
  - delivery_address_id
  - delivery_cost (optional)
  - total_amount (optional)
  - items: [{ book_id, quantity, unit_price }]
- Anonymous: requires anon_token and ownership of book and address

POST /payment/webhook/

- Body: order_id, status=paid, customer_id (optional), transaction_id (optional)
- If customer_id missing: auto-registers from delivery address email/phone
- Triggers anonymous ownership claim when paid
- Optional header: X-Webhook-Secret

POST /retry-pack/create/

- Auth required
- Body: content_type, content_id
- Creates a pending order (tier_name=retry_pack, total_amount=2) and retry pack
- Response includes order_id and retry_pack_order_id

---

## Billing API

Base: /api/billing/

GET /tiers/

- Returns active pricing tiers

GET /ledger/

- Auth required
- Returns user ledger entries

---

## Retry Rules

- PricingTier.max_retries_per_unit is the base retry limit per item
- RetryAllowance tracks used vs max per item
- Retry packs add +3 retries per item for 2 GEL

How to check a book's tier and retries

- Book tier plan: call GET /api/product/books/<uuid:item_id>/
  - Response includes pricing_tier for logged-in users
  - If pricing_tier is null, the book is not paid
- Retry allowance: try POST to the version endpoint for that item
  - If allowed, the generation succeeds and returns pricing_tier
  - If not allowed, you get a 403 with max_retries and used_retries

---

## Common Errors

- 401: Authentication required (pages, retry pack apply, ledger)
- 403: Ownership or retry limit violations
- 400: Validation errors

---

## Notes

- Anonymous ownership uses anon_token cookie/header and IP/UA hash validation.
- Address for anonymous users uses Address.session_key = anon_token.
- Payment provider integration is external; webhook expects a paid status.
